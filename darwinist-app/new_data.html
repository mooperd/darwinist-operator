<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JSON Editor</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    .json-editor {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
      max-width: 800px;
      margin: 20px auto;
    }
    textarea {
      width: 100%;
      height: 300px;
      font-family: monospace;
    }
    .btn {
      padding: 10px;
      cursor: pointer;
      margin: 5px;
      background-color: #008cba;
      color: white;
      border: none;
    }
    .btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .output {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <div class="json-editor">
    <h2>JSON File Editor</h2>

    <!-- File Load/Save Section -->
    <input type="file" id="loadJsonFile" accept=".json" />
    <button class="btn" onclick="saveJsonFile()">Save JSON</button>

    <!-- JSON Text Editor -->
    <textarea id="jsonEditor"></textarea>

    <!-- Product and Approval Addition -->
    <button class="btn" onclick="addProduct()">Add Product</button>
    <button class="btn" onclick="addApproval()">Add Approval</button>

    <!-- Output -->
    <h3>Output:</h3>
    <div class="output" id="jsonOutput"></div>
  </div>

  <script>
    let jsonData = {
      ContactEmail: "",
      VendorID: "",
      VendorName: "",
      Website: "",
      products: []
    };

    const jsonEditor = document.getElementById("jsonEditor");
    const jsonOutput = document.getElementById("jsonOutput");

    // Load JSON File
    document.getElementById("loadJsonFile").addEventListener("change", loadJsonFile);

    function loadJsonFile(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            jsonData = JSON.parse(e.target.result);
            jsonEditor.value = JSON.stringify(jsonData, null, 2);
          } catch (error) {
            alert("Invalid JSON file");
          }
        };
        reader.readAsText(file);
      }
    }

    // Save JSON File
    function saveJsonFile() {
      const updatedJson = jsonEditor.value;
      try {
        jsonData = JSON.parse(updatedJson);
        const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: "application/json" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "updated_file.json";
        link.click();
      } catch (error) {
        alert("Invalid JSON structure. Please correct it.");
      }
    }

    // Add a new product
    function addProduct() {
      const newProduct = {
        DICOMOutput: "new",
        Description: "New product description",
        PrePopulatedReports: false,
        ProductID: generateUUID(),
        ProductName: "New Product",
        ResultsDisplayedInIDS7: false,
        WorklistIntegration: false,
        regulatory_approved_pathologies: []
      };

      jsonData.products.push(newProduct);
      jsonEditor.value = JSON.stringify(jsonData, null, 2);
      updateOutput();
    }

    // Add a new regulatory approval to the first product
    function addApproval() {
      if (jsonData.products.length === 0) {
        alert("No products available to add approvals. Please add a product first.");
        return;
      }

      const newApproval = {
        approval_date: new Date().toISOString().split("T")[0],
        approval_status: "pending",
        approved_by: "approver",
        id: generateUUID(),
        name: "New Approval"
      };

      // Assuming we add approval to the first product
      jsonData.products[0].regulatory_approved_pathologies.push(newApproval);
      jsonEditor.value = JSON.stringify(jsonData, null, 2);
      updateOutput();
    }

    // Update Output Display
    function updateOutput() {
      jsonOutput.innerText = JSON.stringify(jsonData, null, 2);
    }

    // UUID Generator for IDs
    function generateUUID() {
      return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function (c) {
        const r = (Math.random() * 16) | 0,
          v = c === "x" ? r : (r & 0x3) | 0x8;
        return v.toString(16);
      });
    }

    // Load initial JSON into the editor
    jsonEditor.value = JSON.stringify(jsonData, null, 2);
    updateOutput();
  </script>
</body>
</html>